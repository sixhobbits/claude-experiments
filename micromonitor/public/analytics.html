<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroMonitor - Analytics Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .analytics-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .analytics-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }
        
        .analytics-label {
            color: #666;
            font-size: 14px;
        }
        
        .report-section {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .report-content {
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .trend-chart {
            height: 200px;
            margin-top: 10px;
        }
        
        .refresh-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        
        .refresh-button:hover {
            background: #218838;
        }
        
        .refresh-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .date-selector {
            margin-bottom: 20px;
        }
        
        .date-selector input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .analytics-nav {
            margin-bottom: 20px;
        }
        
        .analytics-nav button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .analytics-nav button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MicroMonitor Analytics</h1>
            <div class="user-info" id="userInfo"></div>
        </div>
        
        <div class="analytics-nav">
            <button class="active" onclick="showView('summary')">Summary</button>
            <button onclick="showView('report')">Full Report</button>
            <button onclick="showView('history')">History</button>
            <button onclick="location.href='/'">Back to Dashboard</button>
        </div>
        
        <div class="analytics-container">
            <!-- Summary View -->
            <div id="summaryView">
                <button class="refresh-button" onclick="runAnalytics()" id="runAnalyticsBtn">
                    Run Analytics Now
                </button>
                
                <h2>Today's Analytics Summary</h2>
                
                <div class="analytics-grid" id="analyticsGrid">
                    <div class="analytics-card">
                        <h3>Unique Visitors</h3>
                        <div class="analytics-value" id="visitorsCount">-</div>
                        <div class="analytics-label">Total unique IPs</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>API Calls</h3>
                        <div class="analytics-value" id="apiCallsCount">-</div>
                        <div class="analytics-label">Total API requests</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Login Attempts</h3>
                        <div class="analytics-value" id="loginCount">-</div>
                        <div class="analytics-label">Authentication attempts</div>
                    </div>
                    
                    <div class="analytics-card">
                        <h3>Demo Activity</h3>
                        <div class="analytics-value" id="demoCount">-</div>
                        <div class="analytics-label">Demo account usage</div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>7-Day Trend</h3>
                    <canvas id="trendChart" class="trend-chart"></canvas>
                </div>
            </div>
            
            <!-- Full Report View -->
            <div id="reportView" style="display: none;">
                <h2>Full Analytics Report</h2>
                <div class="report-section">
                    <div class="report-content" id="fullReport">Loading report...</div>
                </div>
            </div>
            
            <!-- History View -->
            <div id="historyView" style="display: none;">
                <h2>Analytics History</h2>
                <div class="date-selector">
                    <input type="date" id="dateSelector" onchange="loadHistoricalData()">
                    <button onclick="loadHistoricalData()">Load Data</button>
                </div>
                <div id="historicalData"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        let trendChart = null;
        
        // Check authentication
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        
        if (!token) {
            window.location.href = '/login.html';
        }
        
        document.getElementById('userInfo').textContent = `Logged in as: ${username}`;
        
        // View management
        function showView(view) {
            document.querySelectorAll('.analytics-nav button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('summaryView').style.display = view === 'summary' ? 'block' : 'none';
            document.getElementById('reportView').style.display = view === 'report' ? 'block' : 'none';
            document.getElementById('historyView').style.display = view === 'history' ? 'block' : 'none';
            
            if (view === 'report') {
                loadFullReport();
            }
        }
        
        // Load analytics summary
        async function loadAnalyticsSummary() {
            try {
                const response = await fetch('/api/analytics/summary', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('visitorsCount').textContent = data.visitors;
                    document.getElementById('apiCallsCount').textContent = data.apiCalls;
                    document.getElementById('loginCount').textContent = data.loginAttempts;
                    document.getElementById('demoCount').textContent = data.demoActivity;
                }
            } catch (error) {
                console.error('Error loading analytics summary:', error);
            }
        }
        
        // Load full report
        async function loadFullReport() {
            try {
                const response = await fetch('/api/analytics/report', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const report = await response.text();
                    document.getElementById('fullReport').textContent = report;
                } else {
                    document.getElementById('fullReport').textContent = 'No report available. Click "Run Analytics Now" to generate one.';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('fullReport').textContent = 'Error loading report';
            }
        }
        
        // Load trends
        async function loadTrends() {
            try {
                const response = await fetch('/api/analytics/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const history = await response.json();
                    displayTrendChart(history);
                }
            } catch (error) {
                console.error('Error loading trends:', error);
            }
        }
        
        // Display trend chart
        function displayTrendChart(history) {
            const dates = [];
            const visitors = [];
            const apiCalls = [];
            const logins = [];
            
            // Get last 7 days
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                dates.push(dateStr);
                
                if (history[dateStr] && history[dateStr].length > 0) {
                    const latest = history[dateStr][history[dateStr].length - 1];
                    visitors.push(latest.visitors.unique_count);
                    apiCalls.push(latest.api_usage.total_calls);
                    logins.push(latest.login_attempts.total);
                } else {
                    visitors.push(0);
                    apiCalls.push(0);
                    logins.push(0);
                }
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Visitors',
                        data: visitors,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'API Calls',
                        data: apiCalls,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Logins',
                        data: logins,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Run analytics manually
        async function runAnalytics() {
            const btn = document.getElementById('runAnalyticsBtn');
            btn.disabled = true;
            btn.textContent = 'Running...';
            
            try {
                const response = await fetch('/api/analytics/run', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Analytics generated successfully!');
                    loadAnalyticsSummary();
                    loadTrends();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                alert('Error running analytics: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Analytics Now';
            }
        }
        
        // Load historical data
        async function loadHistoricalData() {
            const date = document.getElementById('dateSelector').value;
            if (!date) return;
            
            try {
                const response = await fetch(`/api/analytics/date/${date}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayHistoricalData(data);
                } else {
                    document.getElementById('historicalData').innerHTML = '<p>No data available for this date</p>';
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }
        
        // Display historical data
        function displayHistoricalData(dataArray) {
            if (!dataArray || dataArray.length === 0) {
                document.getElementById('historicalData').innerHTML = '<p>No data available</p>';
                return;
            }
            
            // Use the latest data for the day
            const data = dataArray[dataArray.length - 1];
            
            let html = '<div class="analytics-grid">';
            html += `
                <div class="analytics-card">
                    <h3>Visitors</h3>
                    <div class="analytics-value">${data.visitors.unique_count}</div>
                </div>
                <div class="analytics-card">
                    <h3>API Calls</h3>
                    <div class="analytics-value">${data.api_usage.total_calls}</div>
                </div>
                <div class="analytics-card">
                    <h3>Login Attempts</h3>
                    <div class="analytics-value">${data.login_attempts.total}</div>
                </div>
                <div class="analytics-card">
                    <h3>Demo Activity</h3>
                    <div class="analytics-value">${data.login_attempts.demo_account}</div>
                </div>
            `;
            html += '</div>';
            
            // Add detailed information
            html += '<div class="report-section">';
            html += '<h3>Top API Endpoints</h3><ul>';
            for (const [endpoint, count] of Object.entries(data.api_usage.top_endpoints || {})) {
                html += `<li><code>${endpoint}</code>: ${count} calls</li>`;
            }
            html += '</ul></div>';
            
            document.getElementById('historicalData').innerHTML = html;
        }
        
        // Initialize
        loadAnalyticsSummary();
        loadTrends();
        
        // Set today's date in date selector
        document.getElementById('dateSelector').valueAsDate = new Date();
    </script>
</body>
</html>